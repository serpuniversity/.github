name: Create gist from markdown file

on:
  workflow_call:
    inputs:
      file_path:
        description: 'relative path to the markdown file (.md) in the repository to create'
        required: true
        type: string
    secrets:
      GH_PAT_PROFESSOR_SERP:
        required: true

jobs:
  create-gist:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Validate and read markdown file
        id: read_file
        shell: bash
        run: |
          # Check if file exists
          if [ ! -f "${{ inputs.file_path }}" ]; then
            echo "Error: File not found at ${{ inputs.file_path }}"
            exit 1
          fi
          
          # Check if file is markdown
          if [[ ! "${{ inputs.file_path }}" =~ \.md$ ]]; then
            echo "Error: File must be a markdown file (.md)"
            exit 1
          fi
          
          # Read the file content (raw, not JSON-encoded yet)
          FILE_CONTENT=$(cat "${{ inputs.file_path }}")
          echo "file_content<<EOF" >> $GITHUB_OUTPUT
          echo "$FILE_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Get the filename
          FILENAME=$(basename "${{ inputs.file_path }}")
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          
          # Extract title from frontmatter if it exists
          DESCRIPTION=""
          if head -n 1 "${{ inputs.file_path }}" | grep -q "^---"; then
            # File has frontmatter, extract title
            FRONTMATTER=$(sed -n '/^---$/,/^---$/p' "${{ inputs.file_path }}" | sed '1d;$d')
            # Extract title, removing only surrounding quotes if present
            TITLE_LINE=$(echo "$FRONTMATTER" | grep "^title:")
            DESCRIPTION=$(echo "$TITLE_LINE" | sed 's/^title:[[:space:]]*//')
            # Remove surrounding quotes only if they exist
            DESCRIPTION=$(echo "$DESCRIPTION" | sed 's/^"\(.*\)"$/\1/' | sed "s/^'\(.*\)'$/\1/")
          fi
          
          # Use default description if no title found in frontmatter
          if [ -z "$DESCRIPTION" ]; then
            DESCRIPTION="Mirror of ${{ inputs.file_path }} from ${{ github.repository }}"
          fi
          
          # Use heredoc to preserve special characters
          echo "description<<EOF" >> $GITHUB_OUTPUT
          echo "$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Create or update gist
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT_PROFESSOR_SERP }}
        shell: bash
        run: |
          # Prepare the gist payload
          FILENAME="${{ steps.read_file.outputs.filename }}"
          
          # Read the raw file content and create JSON payload
          cat "${{ inputs.file_path }}" | jq -Rs --arg desc "${{ steps.read_file.outputs.description }}" --arg fname "$FILENAME" \
            '{description: $desc, public: true, files: {($fname): {content: .}}}' > payload.json
          
          # Create the gist using GitHub API
          RESPONSE=$(curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/gists \
            -d @payload.json)
          
          # Extract and display the gist URL
          GIST_URL=$(echo "$RESPONSE" | jq -r '.html_url')
          
          if [ "$GIST_URL" = "null" ] || [ -z "$GIST_URL" ]; then
            echo "Error creating gist:"
            echo "$RESPONSE" | jq .
            exit 1
          fi
          
          echo "‚úÖ Gist created successfully!"
          echo "üìé Gist URL: $GIST_URL"
          echo "üìÅ Mirrored file: ${{ inputs.file_path }}"